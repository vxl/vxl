USES += core
USE_OPENGL:=1
TRY_GLUT := 1 # vgui_text needs glut. fsm.
TRY_X11 := 1
TRY_HERMES := 1
LIBRARY := vgui
IMMEDIATE_LIBS += -lvil1 -lvil -lvbl -lvnl -lvul

#######################################
include ${IUEROOT}/config/top-params.mk
#######################################

# basic classes
SOURCES += vgui.cxx
SOURCES += vgui_toolkit.cxx
SOURCES += vgui_tag.cxx
SOURCES += vgui_window.cxx
SOURCES += vgui_adaptor.cxx
SOURCES += vgui_tableau.cxx
MANPAGE_SOURCES += vgui_tableau_sptr.h
SOURCES += vgui_parent_child_link.cxx
SOURCES += vgui_key.cxx
SOURCES += vgui_button.cxx
SOURCES += vgui_modifier.cxx
SOURCES += vgui_event.cxx
SOURCES += vgui_command.cxx
MANPAGE_SOURCES += vgui_command_sptr.h
SOURCES += vgui_menu.cxx
MANPAGE_SOURCES += vgui_popup_params.h
MANPAGE_SOURCES += vgui_message.h
SOURCES += vgui_observer.cxx
SOURCES += vgui_observable.cxx
MANPAGE_SOURCES += vgui_satellite_tableau.txx
MANPAGE_SOURCES += vgui_range_map.txx
MANPAGE_SOURCES += vgui_range_map_params.h
MANPAGE_SOURCES += vgui_range_map_params_sptr.h

# utility
SOURCES += vgui_find.cxx
SOURCES += vgui_utils.cxx
SOURCES += vgui_macro.cxx
SOURCES += vgui_color.cxx
SOURCES += vgui_projection_inspector.cxx
SOURCES += vgui_matrix_state.cxx
SOURCES += vgui_text_graph.cxx
SOURCES += vgui_camera.cxx
SOURCES += vgui_event_condition.cxx

# images
SOURCES += internals/vgui_rasterpos.cxx
SOURCES += vgui_pixel.cxx
FLAGS_vgui_pixel.cxx := $(optimize)
SOURCES += vgui_section_render.cxx
SOURCES += vgui_section_buffer.cxx
SOURCES += vgui_texture_hacks.cxx
SOURCES += vgui_cache_wizard.cxx
SOURCES += vgui_image_renderer.cxx
SOURCES += vgui_image_tableau.cxx
MANPAGE_SOURCES += vgui_image_tableau_sptr.h
SOURCES += vgui_blender_tableau.cxx
MANPAGE_SOURCES += vgui_blender_tableau_sptr.h

# tableau mixins and miscellaneous
SOURCES += vgui_wrapper_tableau.cxx
MANPAGE_SOURCES += vgui_wrapper_tableau_sptr.h
SOURCES += vgui_deck_tableau.cxx
MANPAGE_SOURCES += vgui_deck_tableau_sptr.h
SOURCES += vgui_composite_tableau.cxx
MANPAGE_SOURCES += vgui_composite_tableau_sptr.h
SOURCES += vgui_poly_tableau.cxx
MANPAGE_SOURCES += vgui_poly_tableau_sptr.h
SOURCES += vgui_grid_tableau.cxx
MANPAGE_SOURCES += vgui_grid_tableau_sptr.h
SOURCES += vgui_drag_mixin.cxx
SOURCES += vgui_active_tableau.cxx
MANPAGE_SOURCES += vgui_active_tableau_sptr.h
MANPAGE_SOURCES += vgui_drag_tableau.h
MANPAGE_SOURCES += vgui_drag_tableau_sptr.h
SOURCES += vgui_clear_tableau.cxx
MANPAGE_SOURCES += vgui_clear_tableau_sptr.h
SOURCES += vgui_debug_tableau.cxx
MANPAGE_SOURCES += vgui_debug_tableau_sptr.h
SOURCES += vgui_quit_tableau.cxx
MANPAGE_SOURCES += vgui_quit_tableau_sptr.h
SOURCES += vgui_tview_launcher_tableau.cxx
MANPAGE_SOURCES += vgui_tview_launcher_tableau_sptr.h
SOURCES += vgui_shell_tableau.cxx
MANPAGE_SOURCES += vgui_shell_tableau_sptr.h
SOURCES += vgui_text_put.cxx
SOURCES += vgui_text_tableau.cxx
MANPAGE_SOURCES += vgui_text_tableau_sptr.h
SOURCES += vgui_blackbox_tableau.cxx
MANPAGE_SOURCES += vgui_blackbox_tableau_sptr.h
SOURCES += vgui_enhance_tableau.cxx
MANPAGE_SOURCES += vgui_enhance_tableau_sptr.h
SOURCES += vgui_tview_tableau.cxx
MANPAGE_SOURCES += vgui_tview_tableau_sptr.h
SOURCES += vgui_function_tableau.cxx
MANPAGE_SOURCES += vgui_function_tableau_sptr.h
SOURCES += vgui_roi_tableau.cxx
MANPAGE_SOURCES += vgui_roi_tableau_sptr.h
SOURCES += vgui_rubberband_tableau.cxx
MANPAGE_SOURCES += vgui_rubberband_tableau_sptr.h
SOURCES += vgui_loader_tableau.cxx
MANPAGE_SOURCES += vgui_loader_tableau_sptr.h
SOURCES += vgui_color_text.cxx
SOURCES += vgui_event_server.cxx
SOURCES += vgui_error_dialog.cxx

# pcp
SOURCES += vgui_soview.cxx
SOURCES += vgui_soview2D.cxx
SOURCES += vgui_soview3D.cxx
SOURCES += vgui_style.cxx
MANPAGE_SOURCES += vgui_style_sptr.h
SOURCES += vgui_displaybase_tableau.cxx
MANPAGE_SOURCES += vgui_displaybase_tableau_sptr.h
SOURCES += vgui_displaylist2D_tableau.cxx
MANPAGE_SOURCES += vgui_displaylist2D_tableau_sptr.h
SOURCES += vgui_displaylist3D_tableau.cxx
MANPAGE_SOURCES += vgui_displaylist3D_tableau_sptr.h
SOURCES += vgui_easy2D_tableau.cxx
MANPAGE_SOURCES += vgui_easy2D_tableau_sptr.h
SOURCES += vgui_easy3D_tableau.cxx
MANPAGE_SOURCES += vgui_easy3D_tableau_sptr.h
SOURCES += vgui_listmanager2D_tableau.cxx
MANPAGE_SOURCES += vgui_listmanager2D_tableau_sptr.h
SOURCES += internals/trackball.c      # name
SOURCES += vgui_viewer2D_tableau.cxx
MANPAGE_SOURCES += vgui_viewer2D_tableau_sptr.h
SOURCES += vgui_viewer3D_tableau.cxx
MANPAGE_SOURCES += vgui_viewer3D_tableau_sptr.h

# dialog classes
SOURCES += vgui_dialog.cxx
MANPAGE_SOURCES += internals/vgui_dialog_field.h
SOURCES += internals/vgui_simple_field.cxx
MANPAGE_SOURCES += internals/vgui_string_field.h
MANPAGE_SOURCES += internals/vgui_file_field.h
SOURCES += internals/vgui_dialog_impl.cxx

# statusbar classes
SOURCES += vgui_statusbuf.cxx
MANPAGE_SOURCES += vgui_statusbar.h

# vil2 support
SOURCES += vgui_vil_image_renderer.cxx

# internals
SOURCES += internals/vgui_invert_homg4x4.cxx
SOURCES += internals/vgui_back_project.cxx
SOURCES += internals/vgui_un_project.cxx
SOURCES += internals/vgui_adaptor_tableau.cxx
MANPAGE_SOURCES += internals/vgui_parent_child_link_data.h
MANPAGE_SOURCES += internals/vgui_adaptor_mixin.h
SOURCES += internals/vgui_overlay_helper.cxx
SOURCES += internals/vgui_multiply_4x4.cxx
SOURCES += internals/vgui_transpose_4x4.cxx
SOURCES += internals/vgui_draw_line.cxx

# extra header files
MANPAGE_SOURCES += vgui_fwd.h
MANPAGE_SOURCES += vgui_gl.h
MANPAGE_SOURCES += vgui_glu.h
MANPAGE_SOURCES += vgui_glx.h

# Mesa-X11 accelerated functions using Hermes
SOURCES += internals/vgui_accelerate.cxx
SOURCES += internals/vgui_accelerate_tag.cxx
MANPAGE_SOURCES += internals/vgui_gl_selection_macros.h
ifeq (1,$(HAS_X11))
SOURCES += internals/vgui_accelerate_x11.cxx
endif

# VRML I/O -- uses Qv
USES += v3p
SOURCES += vrml/vgui_vrml_texture_map.cxx
SOURCES += vrml/vgui_vrml_draw_visitor.cxx
SOURCES += vrml/vgui_vrml_tableau.cxx
AUX_SOURCE_DIRECTORY += vrml/Templates

ifeq ($(HAS_GLUT),1)
SOURCES += vgui_glut.cxx
SOURCES += impl/glut/vgui_glut_adaptor.cxx
SOURCES += impl/glut/vgui_glut_impl.cxx
SOURCES += impl/glut/vgui_glut_popup_impl.cxx
SOURCES += impl/glut/vgui_glut_tag.cxx
SOURCES += impl/glut/vgui_glut_window.cxx
MANPAGE_SOURCES += impl/glut/menu_hack.h
ifeq ($(HAS_X11),1)
SOURCES += impl/glut/menu_hack_X11.cxx
else
SOURCES += impl/glut/menu_hack_none.cxx
endif
AUX_SOURCE_DIRECTORY += impl/glut/Templates
endif

ifeq ($(HAS_GTK2),1)
INCDIRS += $(GTK2_INC_DIRS)
DEFINES += $(GTK2CONFIGCFLAGS) -DVGUI_USE_GTK2
SOURCES += impl/gtk2/vgui_gtk2.cxx
SOURCES += impl/gtk2/vgui_gtk2_adaptor.cxx
SOURCES += impl/gtk2/vgui_gtk2_dialog_impl.cxx
SOURCES += impl/gtk2/vgui_gtk2_statusbar.cxx
SOURCES += impl/gtk2/vgui_gtk2_tag.cxx
SOURCES += impl/gtk2/vgui_gtk2_utils.cxx
SOURCES += impl/gtk2/vgui_gtk2_window.cxx
AUX_SOURCE_DIRECTORY += impl/gtk2/Templates
else
ifeq ($(HAS_GTKGLAREA),1)
INCDIRS += $(GTKGLAREA_INC_DIR) $(GTK_INC_DIRS)
DEFINES += $(GTKCONFIGCFLAGS) -DVGUI_USE_GTK
SOURCES += impl/gtk/vgui_gtk.cxx
SOURCES += impl/gtk/vgui_gtk_adaptor.cxx
SOURCES += impl/gtk/vgui_gtk_dialog_impl.cxx
SOURCES += impl/gtk/vgui_gtk_statusbar.cxx
SOURCES += impl/gtk/vgui_gtk_tag.cxx
SOURCES += impl/gtk/vgui_gtk_utils.cxx
SOURCES += impl/gtk/vgui_gtk_window.cxx
AUX_SOURCE_DIRECTORY += impl/gtk/Templates
endif
endif

ifeq ($(HAS_QGL), 1)
SOURCES += impl/qt/vgui_qt.cxx
SOURCES += impl/qt/vgui_qt_adaptor.cxx
SOURCES += impl/qt/vgui_qt_dialog_impl.cxx
SOURCES += impl/qt/vgui_qt_menu.cxx
SOURCES += impl/qt/vgui_qt_statusbar.cxx
SOURCES += impl/qt/vgui_qt_tag.cxx
SOURCES += impl/qt/vgui_qt_window.cxx

CPPEXT = cxx
HPPEXT = h
ALLHEADERS := $(wildcard $(SOURCES:.$(CPPEXT)=.$(HPPEXT)))
MOCHEADERS := $(shell fgrep -l Q_OBJECT $(ALLHEADERS))
MOCSOURCES := $(MOCHEADERS:.$(HPPEXT)=_mocced.$(CPPEXT))

SOURCES += ${MOCSOURCES}
DEFINES += -DQT_NO_STL

ifeq ($(OS),OSF1V4)
FLAGS_impl/qt/vgui_qt_adaptor_mocced.cxx := -O0
# because of an "internal compile error" of gcc2.95 whenever optimisation is on, even -O1
endif

endif

ifeq ($(HAS_MFC), 1)
SOURCES += impl/mfc/vgui_mfc.cxx
SOURCES += impl/mfc/vgui_mfc_adaptor.cxx
SOURCES += impl/mfc/vgui_mfc_app.cxx
SOURCES += impl/mfc/vgui_mfc_app_init.cxx
SOURCES += impl/mfc/vgui_mfc_dialog_impl.cxx
SOURCES += impl/mfc/vgui_mfc_doc.cxx
SOURCES += impl/mfc/vgui_mfc_mainfrm.cxx
SOURCES += impl/mfc/vgui_mfc_statusbar.cxx
SOURCES += impl/mfc/vgui_mfc_tag.cxx
SOURCES += impl/mfc/vgui_mfc_utils.cxx
SOURCES += impl/mfc/vgui_mfc_view.cxx
SOURCES += impl/mfc/vgui_mfc_window.cxx
endif

# This file uses the -DVGUI_USE_* preprocessor definitions set by
# the implementations to register each toolkit that was compiled in.
SOURCES += vgui_register_all.cxx


# -O2 does not turn on inlining, so make sure we use -O3 for egcs and 2.95.
# Also quell warning about truncating unsigned to fit bitfield.
ifeq ($(strip $(IU_COMPILER)),gcc-2.95)
optimize := -O3 -w
endif
ifeq ($(strip $(IU_COMPILER)),egcs)
optimize := -O3 -w
endif
ifeq ($(strip $(IU_COMPILER)),) #gcc
optimize := -O3 -w
endif

#####################
# SUBDIRS
#####################
ifndef NOTEST
SUBDIRS += tests
SUBDIRS += examples
endif

######################################
include ${IUEROOT}/config/top-rules.mk
######################################

# on HP unix, this library has become too big, so it needs -fPIC
ifeq "HP-UX" "$(findstring HP-UX,$(OS))"
pic = $(PIC)
endif

ifeq ($(HAS_QGL), 1)
%_mocced.$(CPPEXT): %.$(HPPEXT)
	@echo "--- Moccing $<"
	$(MOC) $< -o $@

mocclean:
	find . -name \*_mocced.\* -print | xargs $(RM) ; true

cleaner: mocclean clean

endif
